// Urban Simple Platform - Database Schema
// Using Prisma with Supabase (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Company {
  id        String   @id @default(cuid())
  name      String
  legalName String?  @map("legal_name")
  taxId     String?  @map("tax_id")
  address   Json?
  phone     String?
  email     String?
  website   String?
  logoUrl   String?  @map("logo_url")
  settings  Json?    @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  branches Branch[]
  users    User[]

  // Business Development
  prospects         Prospect[]
  outreachCampaigns OutreachCampaign[]
  discoveryJobs     AIDiscoveryJob[]
  contentTemplates  ContentTemplate[]
  automationLogs    GrowthAutomationLog[]

  @@map("companies")
}

model Branch {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  name      String // Austin, Dallas, San Antonio
  code      String // AUS, DAL, SA
  address   Json?
  phone     String?
  email     String?
  timezone  String   @default("America/Chicago")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users      User[]
  clients    Client[]
  locations  Location[]
  shifts     Shift[]
  payPeriods PayPeriod[]
  prospects  Prospect[]

  @@map("branches")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ASSOCIATE
  CLIENT_USER
}

model User {
  id             String    @id @default(cuid())
  authId         String?   @unique @map("auth_id") // Supabase auth user id
  companyId      String    @map("company_id")
  branchId       String?   @map("branch_id") // null for super admin
  email          String    @unique
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  displayName    String?   @map("display_name")
  phone          String?
  role           UserRole  @default(ASSOCIATE)
  secondaryRoles String[]  @default([]) @map("secondary_roles")
  avatarUrl      String?   @map("avatar_url")
  isActive       Boolean   @default(true) @map("is_active")
  lastLogin         DateTime? @map("last_login")
  emailSignature    String?   @db.Text @map("email_signature")
  signatureLogoUrl  String?   @map("signature_logo_url")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch  Branch? @relation(fields: [branchId], references: [id])

  // Associate-specific
  associate Associate?

  // Relationships
  assignedLocations LocationAssignment[]
  shiftsAsAssociate Shift[]              @relation("ShiftAssociate")
  shiftsAsManager   Shift[]              @relation("ShiftManager")
  serviceLogs       ServiceLog[]
  reviewsGiven      ServiceReview[]      @relation("ReviewerReviews")
  reviewsReceived   ServiceReview[]      @relation("AssociateReviews")
  issuesReported    Issue[]              @relation("IssueReporter")
  issuesAssigned    Issue[]              @relation("IssueAssignee")
  issueComments     IssueComment[]
  notifications     Notification[]
  badgesEarned      BadgeEarned[]
  payrollEntries    PayrollEntry[]
  auditLogs         AuditLog[]
  aiConversations   AIConversation[]

  // Business Development
  assignedProspects    Prospect[]         @relation("ProspectAssignee")
  prospectActivities   ProspectActivity[]
  createdCampaigns     OutreachCampaign[] @relation("CampaignCreator")
  createdDiscoveryJobs AIDiscoveryJob[]   @relation("DiscoveryJobCreator")
  createdTemplates     ContentTemplate[]  @relation("TemplateCreator")

  // Pulse - Daily Briefings
  pulseTopics    PulseTopic[]
  pulseBriefings PulseBriefing[]

  // Blog
  blogPosts BlogPost[]

  // Task Management
  projects Project[]
  tasks    Task[]
  taskTags TaskTag[]
  goals    Goal[]

  @@map("users")
}

model Associate {
  id                    String    @id @default(cuid())
  userId                String    @unique @map("user_id")
  startDate             DateTime? @map("start_date")
  emergencyContact      Json?     @map("emergency_contact")
  documents             Json?     @default("[]") // contracts, IDs, etc.
  onboardingStatus      String    @default("pending") @map("onboarding_status")
  onboardingCompletedAt DateTime? @map("onboarding_completed_at")
  totalPoints           Int       @default(0) @map("total_points")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("associates")
}

// ============================================
// CLIENTS & LOCATIONS
// ============================================

model Client {
  id                     String   @id @default(cuid())
  companyId              String   @map("company_id")
  branchId               String   @map("branch_id")
  name                   String
  legalName              String?  @map("legal_name")
  billingEmail           String?  @map("billing_email")
  phone                  String?
  address                Json?
  billingAddress         Json?    @map("billing_address")
  logoUrl                String?  @map("logo_url")
  paymentTerms           String   @default("NET_30") @map("payment_terms") // NET_15, NET_30, DUE_ON_RECEIPT
  preferredPaymentMethod String?  @map("preferred_payment_method") // ach, credit_card, check
  taxExempt              Boolean  @default(false) @map("tax_exempt")
  notes                  String?
  status                 String   @default("active") // active, inactive, churned
  healthScore            Int?     @map("health_score") // 0-100
  loyaltyPoints          Int      @default(0) @map("loyalty_points")
  loyaltyTier            String   @default("bronze") @map("loyalty_tier") // bronze, silver, gold, platinum
  qbCustomerId           String?  @map("qb_customer_id") // QuickBooks sync
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  branch Branch @relation(fields: [branchId], references: [id])

  locations             Location[]
  contacts              ClientContact[]
  contracts             Contract[]
  serviceAgreements     ServiceAgreement[]
  invoices              Invoice[]
  payments              Payment[]
  issues                Issue[]
  loyaltyTransactions   LoyaltyTransaction[]
  convertedFromProspect Prospect?            @relation("ProspectToClient")

  @@map("clients")
}

model ClientContact {
  id                  String    @id @default(cuid())
  clientId            String    @map("client_id")
  userId              String?   @map("user_id") // if they have portal access
  firstName           String    @map("first_name")
  lastName            String    @map("last_name")
  email               String
  phone               String?
  role                String    @default("primary") // primary, billing, operations, other
  isPortalUser        Boolean   @default(false) @map("is_portal_user")
  portalAccessGranted DateTime? @map("portal_access_granted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_contacts")
}

model Location {
  id                  String   @id @default(cuid())
  clientId            String   @map("client_id")
  branchId            String   @map("branch_id")
  name                String
  address             Json
  logoUrl             String?  @map("logo_url")
  accessInstructions  String?  @map("access_instructions")
  checklistTemplateId String?  @map("checklist_template_id")
  equipmentInventory  Json?    @default("[]") @map("equipment_inventory")
  serviceNotes        String?  @map("service_notes")
  painPoints          String?  @map("pain_points")
  photos              String[] @default([])
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  client            Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  branch            Branch             @relation(fields: [branchId], references: [id])
  checklistTemplate ChecklistTemplate? @relation(fields: [checklistTemplateId], references: [id])

  assignments       LocationAssignment[]
  shifts            Shift[]
  shiftLocations    ShiftLocation[]
  serviceLogs       ServiceLog[]
  reviews           ServiceReview[]
  issues            Issue[]
  serviceAgreements ServiceAgreement[]

  @@map("locations")
}

model LocationAssignment {
  id         String    @id @default(cuid())
  locationId String    @map("location_id")
  userId     String    @map("user_id") // associate
  monthlyPay Decimal   @map("monthly_pay") @db.Decimal(10, 2)
  startDate  DateTime  @map("start_date")
  endDate    DateTime? @map("end_date")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@map("location_assignments")
}

// ============================================
// SERVICE OPERATIONS
// ============================================

model ChecklistTemplate {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  name        String
  nameEs      String?  @map("name_es") // Spanish
  description String?
  sections    Json // array of sections with items
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  locations   Location[]
  serviceLogs ServiceLog[]

  @@map("checklist_templates")
}

model ChecklistSectionType {
  id        String   @id @default(cuid())
  companyId String?  @map("company_id") // null = built-in
  name      String // "Back of House (Kitchen)"
  nameEs    String?  @map("name_es")
  code      String // "BOH", "BATHROOM", "DINING", "PATIO"
  icon      String? // lucide icon name
  sortOrder Int      @default(0) @map("sort_order")
  isBuiltIn Boolean  @default(false) @map("is_built_in")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  items ChecklistItemLibrary[]

  @@map("checklist_section_types")
}

model ChecklistItemLibrary {
  id            String   @id @default(cuid())
  sectionTypeId String   @map("section_type_id")
  companyId     String?  @map("company_id") // null = built-in
  text          String // "Sweep and mop all floor areas"
  textEs        String?  @map("text_es")
  frequency     String   @default("daily") // daily, weekly, monthly
  requiresPhoto Boolean  @default(false) @map("requires_photo")
  priority      String   @default("normal") // normal, high
  isBuiltIn     Boolean  @default(false) @map("is_built_in")
  isActive      Boolean  @default(true) @map("is_active")
  usageCount    Int      @default(0) @map("usage_count") // for popularity sorting
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  sectionType ChecklistSectionType @relation(fields: [sectionTypeId], references: [id], onDelete: Cascade)

  @@map("checklist_item_library")
}

model Shift {
  id               String   @id @default(cuid())
  locationId       String?  @map("location_id") // Nullable - use shiftLocations for multiple locations
  branchId         String   @map("branch_id")
  associateId      String?  @map("associate_id") // Nullable - supports manager-only shifts
  managerId        String?  @map("manager_id")
  date             DateTime @db.Date
  startTime        String   @map("start_time") // "21:00"
  endTime          String   @map("end_time") // "02:00"
  status           String   @default("scheduled") // scheduled, in_progress, completed, missed, cancelled
  isRecurring      Boolean  @default(false) @map("is_recurring")
  recurringPattern Json?    @map("recurring_pattern")
  notes            String?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  location       Location?       @relation(fields: [locationId], references: [id], onDelete: Cascade)
  branch         Branch          @relation(fields: [branchId], references: [id])
  associate      User?           @relation("ShiftAssociate", fields: [associateId], references: [id])
  manager        User?           @relation("ShiftManager", fields: [managerId], references: [id])
  shiftLocations ShiftLocation[]

  serviceLogs ServiceLog[]

  @@map("shifts")
}

model ShiftLocation {
  id         String   @id @default(cuid())
  shiftId    String   @map("shift_id")
  locationId String   @map("location_id")
  sortOrder  Int      @default(0) @map("sort_order") // For ordering locations in a route
  createdAt  DateTime @default(now()) @map("created_at")

  shift    Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([shiftId, locationId])
  @@map("shift_locations")
}

model ServiceLog {
  id                     String    @id @default(cuid())
  shiftId                String?   @map("shift_id")
  locationId             String    @map("location_id")
  associateId            String    @map("associate_id")
  checklistTemplateId    String?   @map("checklist_template_id")
  serviceDate            DateTime  @map("service_date") @db.Date
  clockIn                DateTime? @map("clock_in")
  clockInLocation        Json?     @map("clock_in_location") // lat/lng
  clockOut               DateTime? @map("clock_out")
  clockOutLocation       Json?     @map("clock_out_location")
  status                 String    @default("in_progress") // in_progress, completed, partial
  checklistData          Json?     @default("{}") @map("checklist_data")
  priorityItemsCompleted Json?     @default("[]") @map("priority_items_completed")
  overallNotes           String?   @map("overall_notes")
  photos                 String[]  @default([])
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  shift             Shift?             @relation(fields: [shiftId], references: [id])
  location          Location           @relation(fields: [locationId], references: [id])
  associate         User               @relation(fields: [associateId], references: [id])
  checklistTemplate ChecklistTemplate? @relation(fields: [checklistTemplateId], references: [id])

  reviews ServiceReview[]
  issues  Issue[]

  @@map("service_logs")
}

model ServiceReview {
  id            String   @id @default(cuid())
  serviceLogId  String?  @map("service_log_id")
  locationId    String   @map("location_id")
  associateId   String   @map("associate_id")
  reviewerId    String   @map("reviewer_id") // manager
  reviewDate    DateTime @map("review_date") @db.Date
  ratingItems   Json?    @default("[]") @map("rating_items") // per-item ratings
  overallRating Decimal  @map("overall_rating") @db.Decimal(2, 1) // 1.0 - 5.0
  photos        String[] @default([])
  notes         String?
  issuesFound   Boolean  @default(false) @map("issues_found")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  serviceLog ServiceLog? @relation(fields: [serviceLogId], references: [id])
  location   Location    @relation(fields: [locationId], references: [id])
  associate  User        @relation("AssociateReviews", fields: [associateId], references: [id])
  reviewer   User        @relation("ReviewerReviews", fields: [reviewerId], references: [id])

  @@map("service_reviews")
}

model Issue {
  id                     String    @id @default(cuid())
  locationId             String    @map("location_id")
  clientId               String    @map("client_id")
  reportedById           String    @map("reported_by_id")
  assignedToId           String?   @map("assigned_to_id")
  serviceLogId           String?   @map("service_log_id")
  category               String // quality, equipment, communication, safety, other
  severity               String    @default("medium") // low, medium, high, critical
  title                  String
  description            String?
  photos                 String[]  @default([])
  status                 String    @default("open") // open, in_progress, resolved, closed
  resolution             String?
  implicatedAssociateIds String[]  @default([]) @map("implicated_associate_ids")
  resolvedAt             DateTime? @map("resolved_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  location   Location    @relation(fields: [locationId], references: [id])
  client     Client      @relation(fields: [clientId], references: [id])
  reportedBy User        @relation("IssueReporter", fields: [reportedById], references: [id])
  assignedTo User?       @relation("IssueAssignee", fields: [assignedToId], references: [id])
  serviceLog ServiceLog? @relation(fields: [serviceLogId], references: [id])

  comments IssueComment[]

  @@map("issues")
}

model IssueComment {
  id         String   @id @default(cuid())
  issueId    String   @map("issue_id")
  userId     String   @map("user_id")
  comment    String
  isInternal Boolean  @default(false) @map("is_internal") // hidden from client
  createdAt  DateTime @default(now()) @map("created_at")

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@map("issue_comments")
}

// ============================================
// CONTRACTS & AGREEMENTS
// ============================================

model Contract {
  id             String    @id @default(cuid())
  clientId       String    @map("client_id")
  contractNumber String    @unique @map("contract_number")
  type           String // service_agreement, associate_employment, other
  status         String    @default("draft") // draft, sent, signed, active, expired, terminated
  startDate      DateTime? @map("start_date")
  endDate        DateTime? @map("end_date")
  autoRenew      Boolean   @default(false) @map("auto_renew")
  renewalTerms   String?   @map("renewal_terms")
  documentUrl    String?   @map("document_url")
  signedAt       DateTime? @map("signed_at")
  signatureData  Json?     @map("signature_data") // e-signature info
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  client            Client             @relation(fields: [clientId], references: [id])
  serviceAgreements ServiceAgreement[]

  @@map("contracts")
}

model ServiceAgreement {
  id            String    @id @default(cuid())
  clientId      String    @map("client_id")
  locationId    String    @map("location_id")
  contractId    String?   @map("contract_id")
  description   String
  monthlyAmount Decimal   @map("monthly_amount") @db.Decimal(10, 2)
  billingDay    Int       @default(1) @map("billing_day") // 1-28
  paymentTerms  String    @default("NET_30") @map("payment_terms")
  startDate     DateTime  @map("start_date")
  endDate       DateTime? @map("end_date")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  client   Client    @relation(fields: [clientId], references: [id])
  location Location  @relation(fields: [locationId], references: [id])
  contract Contract? @relation(fields: [contractId], references: [id])

  invoiceLineItems InvoiceLineItem[]

  @@map("service_agreements")
}

// ============================================
// BILLING & FINANCE
// ============================================

model Invoice {
  id            String    @id @default(cuid())
  clientId      String    @map("client_id")
  invoiceNumber String    @unique @map("invoice_number")
  status        String    @default("draft") // draft, sent, viewed, paid, partial, overdue, void
  issueDate     DateTime  @map("issue_date") @db.Date
  dueDate       DateTime  @map("due_date") @db.Date
  subtotal      Decimal   @db.Decimal(10, 2)
  taxAmount     Decimal   @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount   Decimal   @map("total_amount") @db.Decimal(10, 2)
  amountPaid    Decimal   @default(0) @map("amount_paid") @db.Decimal(10, 2)
  balanceDue    Decimal   @map("balance_due") @db.Decimal(10, 2)
  notes         String?
  terms         String?
  pdfUrl        String?   @map("pdf_url")
  sentAt        DateTime? @map("sent_at")
  viewedAt      DateTime? @map("viewed_at")
  paidAt        DateTime? @map("paid_at")
  qbInvoiceId   String?   @map("qb_invoice_id") // QuickBooks sync
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  client    Client            @relation(fields: [clientId], references: [id])
  lineItems InvoiceLineItem[]
  payments  Payment[]
  reminders PaymentReminder[]

  @@map("invoices")
}

model InvoiceLineItem {
  id                 String   @id @default(cuid())
  invoiceId          String   @map("invoice_id")
  serviceAgreementId String?  @map("service_agreement_id")
  description        String
  quantity           Decimal  @default(1) @db.Decimal(10, 2)
  unitPrice          Decimal  @map("unit_price") @db.Decimal(10, 2)
  amount             Decimal  @db.Decimal(10, 2)
  sortOrder          Int      @default(0) @map("sort_order")
  createdAt          DateTime @default(now()) @map("created_at")

  invoice          Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  serviceAgreement ServiceAgreement? @relation(fields: [serviceAgreementId], references: [id])

  @@map("invoice_line_items")
}

model Payment {
  id                String   @id @default(cuid())
  clientId          String   @map("client_id")
  invoiceId         String?  @map("invoice_id")
  amount            Decimal  @db.Decimal(10, 2)
  paymentMethod     String   @map("payment_method") // ach, credit_card, check, cash, other
  referenceNumber   String?  @map("reference_number") // check number, transaction ID
  paymentDate       DateTime @map("payment_date") @db.Date
  status            String   @default("completed") // pending, completed, failed, refunded
  processorResponse Json?    @map("processor_response")
  notes             String?
  qbPaymentId       String?  @map("qb_payment_id") // QuickBooks sync
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  client  Client   @relation(fields: [clientId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

model PaymentReminder {
  id           String    @id @default(cuid())
  invoiceId    String    @map("invoice_id")
  reminderType String    @map("reminder_type") // upcoming, due, overdue_3, overdue_7, overdue_14, overdue_30
  scheduledFor DateTime  @map("scheduled_for")
  sentAt       DateTime? @map("sent_at")
  emailLogId   String?   @map("email_log_id")
  createdAt    DateTime  @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payment_reminders")
}

// ============================================
// PAYROLL
// ============================================

model PayPeriod {
  id         String    @id @default(cuid())
  branchId   String    @map("branch_id")
  startDate  DateTime  @map("start_date") @db.Date
  endDate    DateTime  @map("end_date") @db.Date
  status     String    @default("open") // open, calculating, approved, paid
  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")
  paidAt     DateTime? @map("paid_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  branch  Branch         @relation(fields: [branchId], references: [id])
  entries PayrollEntry[]

  @@map("pay_periods")
}

model PayrollEntry {
  id          String   @id @default(cuid())
  payPeriodId String   @map("pay_period_id")
  userId      String   @map("user_id") // associate
  basePay     Decimal  @map("base_pay") @db.Decimal(10, 2)
  deductions  Decimal  @default(0) @db.Decimal(10, 2)
  additions   Decimal  @default(0) @db.Decimal(10, 2)
  netPay      Decimal  @map("net_pay") @db.Decimal(10, 2)
  lineItems   Json?    @default("[]") @map("line_items") // breakdown by location
  status      String   @default("pending") // pending, approved, paid
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  payPeriod PayPeriod @relation(fields: [payPeriodId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@map("payroll_entries")
}

// ============================================
// GAMIFICATION
// ============================================

model Badge {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  name        String
  description String?
  iconUrl     String?  @map("icon_url")
  badgeType   String   @map("badge_type") // milestone, engagement, quality, loyalty, special
  rarity      String   @default("common") // common, uncommon, rare, epic, legendary
  criteria    Json? // rules for auto-award
  pointsValue Int      @default(0) @map("points_value")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  earnedBadges BadgeEarned[]

  @@map("badges")
}

model BadgeEarned {
  id        String   @id @default(cuid())
  badgeId   String   @map("badge_id")
  userId    String   @map("user_id")
  earnedAt  DateTime @default(now()) @map("earned_at")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")

  badge Badge @relation(fields: [badgeId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([badgeId, userId])
  @@map("badges_earned")
}

model LoyaltyTransaction {
  id            String   @id @default(cuid())
  clientId      String   @map("client_id")
  type          String // earned, redeemed, expired, adjusted
  points        Int
  balanceAfter  Int      @map("balance_after")
  description   String
  referenceType String?  @map("reference_type") // payment, referral, review, etc.
  referenceId   String?  @map("reference_id")
  createdAt     DateTime @default(now()) @map("created_at")

  client Client @relation(fields: [clientId], references: [id])

  @@map("loyalty_transactions")
}

// ============================================
// COMMUNICATIONS
// ============================================

// Team Chat (Slack Replacement)
model Channel {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  name        String // e.g., "general", "austin-storage", "operations"
  slug        String // URL-friendly name
  description String?
  type        String   @default("public") // public, private, direct_message, ai_assistant
  clientId    String?  @map("client_id") // if client-specific channel
  locationId  String?  @map("location_id") // if location-specific channel
  isArchived  Boolean  @default(false) @map("is_archived")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // AI Assistant fields
  isAiEnabled    Boolean  @default(false) @map("is_ai_enabled") // if this channel has AI assistant
  aiPersona      String?  @map("ai_persona") // hr, payroll, operations, time_off, general
  aiLanguages    String[] @default(["en"]) @map("ai_languages") // ["en", "es"]
  aiSystemPrompt String?  @map("ai_system_prompt") @db.Text // custom system prompt for this AI

  members  ChannelMember[]
  messages Message[]

  @@unique([companyId, slug])
  @@map("channels")
}

model ChannelMember {
  id            String    @id @default(cuid())
  channelId     String    @map("channel_id")
  userId        String    @map("user_id")
  role          String    @default("member") // owner, admin, member
  notifications String    @default("all") // all, mentions, none
  isFavorite    Boolean   @default(false) @map("is_favorite")
  lastReadAt    DateTime? @map("last_read_at")
  joinedAt      DateTime  @default(now()) @map("joined_at")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@map("channel_members")
}

model Message {
  id          String    @id @default(cuid())
  channelId   String    @map("channel_id")
  userId      String    @map("user_id")
  content     String
  contentType String    @default("text") @map("content_type") // text, file, image, system, ai_response
  attachments Json?     @default("[]") // array of file URLs/metadata
  mentions    String[]  @default([]) // user IDs mentioned
  parentId    String?   @map("parent_id") // for threaded replies
  isEdited    Boolean   @default(false) @map("is_edited")
  editedAt    DateTime? @map("edited_at")
  isDeleted   Boolean   @default(false) @map("is_deleted")
  deletedAt   DateTime? @map("deleted_at")
  reactions   Json?     @default("{}") // { "üëç": ["userId1", "userId2"], "‚ù§Ô∏è": ["userId3"] }

  // AI-specific fields
  isAiGenerated Boolean @default(false) @map("is_ai_generated")
  aiModel       String? @map("ai_model") // "gemini-2.0-flash-exp", etc.
  aiMetadata    Json?   @map("ai_metadata") // tokens used, latency, etc.

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  channel Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  parent  Message?  @relation("MessageReplies", fields: [parentId], references: [id])
  replies Message[] @relation("MessageReplies")

  @@index([channelId, createdAt])
  @@index([userId])
  @@map("messages")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  name      String
  category  String // invoice, reminder, welcome, notification, marketing
  subject   String
  bodyHtml  String   @map("body_html")
  bodyText  String?  @map("body_text")
  variables String[] @default([]) // available merge fields
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  emailLogs EmailLog[]

  @@map("email_templates")
}

model EmailLog {
  id              String    @id @default(cuid())
  templateId      String?   @map("template_id")
  recipientEmail  String    @map("recipient_email")
  recipientUserId String?   @map("recipient_user_id")
  subject         String
  body            String
  status          String    @default("queued") // queued, sent, delivered, bounced, failed
  sentAt          DateTime? @map("sent_at")
  openedAt        DateTime? @map("opened_at")
  clickedAt       DateTime? @map("clicked_at")
  errorMessage    String?   @map("error_message")
  createdAt       DateTime  @default(now()) @map("created_at")

  template EmailTemplate? @relation(fields: [templateId], references: [id])

  @@map("email_logs")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  type      String // info, warning, action_required, success
  title     String
  message   String
  link      String? // in-app navigation
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================
// AUDIT
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  action     String // create, update, delete, login, logout, export, etc.
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// AI ASSISTANT
// ============================================

model AIConversation {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String? // Auto-generated from first message or user-provided
  summary   String? // AI-generated summary of conversation
  isActive  Boolean  @default(true) @map("is_active") // false when archived
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AIConversationMessage[]

  @@index([userId, isActive])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AIConversationMessage {
  id             String @id @default(cuid())
  conversationId String @map("conversation_id")
  role           String // user, assistant
  content        String
  language       String @default("en") // en, es

  // Query metadata
  intent     String? // finance, schedule, team, issues, etc.
  confidence Float? // 0-1
  timeframe  String? // today, week, month, etc.

  // Response metadata
  aiModel      String? @map("ai_model") // gemini-2.0-flash-exp
  responseTime Int?    @map("response_time") // milliseconds
  tokensUsed   Int?    @map("tokens_used")

  // Rich attachments (for future use)
  attachments Json? @default("[]") // charts, tables, actions

  // Feedback
  feedback     String? // thumbs_up, thumbs_down
  feedbackNote String? @map("feedback_note")

  createdAt DateTime @default(now()) @map("created_at")

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("ai_conversation_messages")
}

// ============================================
// BUSINESS DEVELOPMENT & GROWTH
// ============================================

model Prospect {
  id           String  @id @default(cuid())
  companyId    String  @map("company_id")
  branchId     String? @map("branch_id")
  assignedToId String? @map("assigned_to_id")

  // Company Information
  companyName  String  @map("company_name")
  legalName    String? @map("legal_name")
  industry     String? // restaurant, hospitality, retail, etc.
  businessType String? @map("business_type") // restaurant, bar, hotel, etc.

  // Location
  address Json? // street, city, state, zip
  website String?
  phone   String?

  // Business Details
  estimatedSize String?  @map("estimated_size") // small, medium, large
  employeeCount Int?     @map("employee_count")
  annualRevenue Decimal? @map("annual_revenue") @db.Decimal(12, 2)
  priceLevel    String?  @map("price_level") // $, $$, $$$, $$$$

  // Status & Pipeline
  status         String   @default("new") // prospect (holding area), new, researching, contacted, engaged, qualified, proposal_sent, won, lost, nurturing
  stage          String? // custom stage name
  priority       String   @default("medium") // low, medium, high, urgent
  estimatedValue Decimal? @map("estimated_value") @db.Decimal(12, 2)

  // Source Attribution
  source       String  @default("manual") // manual, csv_import, ai_discovery, referral, website, meta, other
  sourceDetail String? @map("source_detail") // campaign name, referrer, etc.

  // AI Discovery Data
  discoveryData  Json?     @map("discovery_data") // raw data from APIs
  aiEnriched     Boolean   @default(false) @map("ai_enriched")
  enrichmentDate DateTime? @map("enrichment_date")

  // AI Scoring
  aiScore       Int?    @map("ai_score") // 0-100 fit score
  aiScoreReason String? @map("ai_score_reason") @db.Text // AI explanation
  autoEnriched  Boolean @default(false) @map("auto_enriched")
  enrichedData  Json?   @map("enriched_data") // LinkedIn URL, decision maker, etc.

  // Metadata
  tags                String[] @default([])
  notes               String?  @db.Text
  lostReason          String?  @map("lost_reason") @db.Text
  convertedToClientId String?  @unique @map("converted_to_client_id")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastContactedAt DateTime? @map("last_contacted_at")

  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch            Branch? @relation(fields: [branchId], references: [id])
  assignedTo        User?   @relation("ProspectAssignee", fields: [assignedToId], references: [id])
  convertedToClient Client? @relation("ProspectToClient", fields: [convertedToClientId], references: [id])

  contacts         ProspectContact[]
  activities       ProspectActivity[]
  campaigns        OutreachCampaign[]
  outreachMessages OutreachMessage[]

  @@index([companyId, status])
  @@index([assignedToId])
  @@index([source])
  @@index([createdAt])
  @@map("prospects")
}

model ProspectContact {
  id         String @id @default(cuid())
  prospectId String @map("prospect_id")

  firstName       String  @map("first_name")
  lastName        String  @map("last_name")
  email           String?
  phone           String?
  title           String? // GM, Owner, Facilities Manager, etc.
  role            String  @default("primary") // primary, billing, operations, other
  isDecisionMaker Boolean @default(false) @map("is_decision_maker")

  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  prospect Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  @@index([prospectId])
  @@map("prospect_contacts")
}

model ProspectActivity {
  id         String @id @default(cuid())
  prospectId String @map("prospect_id")
  userId     String @map("user_id")

  type    String // call, email, meeting, note, status_change, task, linkedin, sms, instagram_dm
  channel String? // email, phone, linkedin, sms, instagram, in_person

  title       String?
  description String? @db.Text
  outcome     String? // connected, voicemail, no_answer, interested, not_interested, follow_up

  // For scheduled activities
  scheduledAt DateTime? @map("scheduled_at")
  completedAt DateTime? @map("completed_at")

  // For emails/messages
  subject     String?
  messageBody String?   @map("message_body") @db.Text
  sentAt      DateTime? @map("sent_at")
  openedAt    DateTime? @map("opened_at")
  clickedAt   DateTime? @map("clicked_at")

  // For calls
  duration Int? // seconds

  // Metadata
  metadata Json? // additional channel-specific data

  createdAt DateTime @default(now()) @map("created_at")

  prospect Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@index([prospectId, createdAt])
  @@index([userId])
  @@index([type])
  @@map("prospect_activities")
}

model OutreachCampaign {
  id          String  @id @default(cuid())
  companyId   String  @map("company_id")
  prospectId  String? @map("prospect_id") // null for broadcast campaigns
  createdById String  @map("created_by_id")

  name        String
  description String? @db.Text
  status      String  @default("draft") // draft, active, paused, completed, cancelled

  // Campaign settings
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  // Targeting
  targetCriteria Json? @map("target_criteria") // filters for prospects

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  prospect  Prospect? @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  createdBy User      @relation("CampaignCreator", fields: [createdById], references: [id])

  messages OutreachMessage[]

  @@index([companyId, status])
  @@index([prospectId])
  @@map("outreach_campaigns")
}

model OutreachMessage {
  id         String @id @default(cuid())
  campaignId String @map("campaign_id")
  prospectId String @map("prospect_id")

  step      Int // order in sequence (1, 2, 3...)
  delayDays Int @default(0) @map("delay_days") // days after previous step

  channel String // email, phone, sms, linkedin, instagram_dm
  subject String?
  body    String  @db.Text

  // AI-generated content
  isAiGenerated Boolean @default(false) @map("is_ai_generated")
  aiPrompt      String? @map("ai_prompt") @db.Text

  // Status
  status      String    @default("pending") // pending, sent, delivered, opened, clicked, replied, failed
  scheduledAt DateTime? @map("scheduled_at")
  sentAt      DateTime? @map("sent_at")

  // Approval workflow
  approvalStatus String    @default("pending") @map("approval_status") // pending, approved, rejected
  approvedAt     DateTime? @map("approved_at")
  approvedById   String?   @map("approved_by_id")

  createdAt DateTime @default(now()) @map("created_at")

  campaign OutreachCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prospect Prospect         @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  @@index([campaignId, step])
  @@index([prospectId])
  @@index([status, scheduledAt])
  @@map("outreach_messages")
}

model AIDiscoveryJob {
  id          String @id @default(cuid())
  companyId   String @map("company_id")
  createdById String @map("created_by_id")

  name        String
  description String? @db.Text

  // Search Criteria
  searchCriteria Json @map("search_criteria") // location, type, filters, etc.

  // Source Configuration
  sources String[] @default([]) // google_places, yelp, web_scraper

  // Status
  status   String @default("pending") // pending, running, completed, failed, cancelled
  progress Int    @default(0) // 0-100

  // Results
  resultsFound Int @default(0) @map("results_found")
  resultsAdded Int @default(0) @map("results_added")

  // Scheduling
  isRecurring      Boolean   @default(false) @map("is_recurring")
  recurringPattern Json?     @map("recurring_pattern")
  nextRunAt        DateTime? @map("next_run_at")

  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  errorMessage String?   @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User    @relation("DiscoveryJobCreator", fields: [createdById], references: [id])

  @@index([companyId, status])
  @@index([nextRunAt])
  @@map("ai_discovery_jobs")
}

model ContentTemplate {
  id          String @id @default(cuid())
  companyId   String @map("company_id")
  createdById String @map("created_by_id")

  name     String
  category String @default("general") // email, sms, linkedin, instagram, phone_script
  channel  String // email, phone, sms, linkedin, instagram

  subject String? // for email
  body    String  @db.Text

  // AI Settings
  isAiTemplate   Boolean @default(false) @map("is_ai_template")
  aiInstructions String? @map("ai_instructions") @db.Text

  // Variables
  variables String[] @default([]) // {{company_name}}, {{contact_name}}, etc.

  // Usage
  useCount   Int       @default(0) @map("use_count")
  lastUsedAt DateTime? @map("last_used_at")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User    @relation("TemplateCreator", fields: [createdById], references: [id])

  @@index([companyId, category])
  @@index([channel])
  @@map("content_templates")
}

// ============================================
// PULSE - AI-POWERED DAILY BRIEFINGS
// ============================================

model PulseTopic {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String // "AI & Machine Learning", "Austin Tech Scene"
  description String?  @db.Text
  keywords    String[] @default([]) // Search keywords for content sourcing
  category    String   @default("general") // tech, business, local, industry, personal
  priority    Int      @default(0) // Higher = more content in briefing
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  briefingItems PulseBriefingItem[]

  @@index([userId, isActive])
  @@map("pulse_topics")
}

model PulseBriefing {
  id               String    @id @default(cuid())
  userId           String    @map("user_id")
  date             DateTime  @db.Date
  status           String    @default("generating") // generating, ready, failed
  title            String? // AI-generated title for the day
  greeting         String?   @db.Text // Personalized AI greeting
  summary          String?   @db.Text // AI-generated executive summary
  inspirationQuote String?   @map("inspiration_quote") @db.Text // Daily motivational quote
  generatedAt      DateTime? @map("generated_at")
  readAt           DateTime? @map("read_at")
  aiModel          String?   @map("ai_model") // gemini-2.0-flash-exp
  generationTime   Int?      @map("generation_time") // milliseconds
  errorMessage     String?   @map("error_message") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  items PulseBriefingItem[]

  @@unique([userId, date])
  @@index([userId, date])
  @@map("pulse_briefings")
}

model PulseBriefingItem {
  id             String    @id @default(cuid())
  briefingId     String    @map("briefing_id")
  topicId        String?   @map("topic_id")
  title          String
  summary        String    @db.Text // AI-generated summary
  content        String?   @db.Text // Full AI-generated content
  sourceUrl      String?   @map("source_url")
  sourceName     String?   @map("source_name")
  imageUrl       String?   @map("image_url") // Gemini 3 Pro Image generated
  imagePrompt    String?   @map("image_prompt") @db.Text // Prompt used for image
  imageBase64    String?   @map("image_base64") @db.Text // Base64 encoded image data
  itemType       String    @default("article") @map("item_type") // article, insight, action, business_kpi
  category       String? // tech, business, local, etc.
  sentiment      String? // positive, neutral, negative
  relevanceScore Float?    @map("relevance_score") // 0-1
  sortOrder      Int       @default(0) @map("sort_order")
  isBookmarked   Boolean   @default(false) @map("is_bookmarked")
  isRead         Boolean   @default(false) @map("is_read")
  readAt         DateTime? @map("read_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  briefing PulseBriefing @relation(fields: [briefingId], references: [id], onDelete: Cascade)
  topic    PulseTopic?   @relation(fields: [topicId], references: [id])

  @@index([briefingId, sortOrder])
  @@index([topicId])
  @@map("pulse_briefing_items")
}

model GrowthAutomationLog {
  id           String   @id @default(cuid())
  companyId    String   @map("company_id")
  type         String // discovery, enrichment, sequence, pipeline
  status       String // running, completed, failed
  details      Json     @default("{}")
  errorMessage String?  @map("error_message") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([type, status])
  @@map("growth_automation_logs")
}

model PulseGenerationLog {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  briefingId   String?  @map("briefing_id")
  type         String // text_generation, image_generation, content_fetch, web_search
  status       String // started, completed, failed
  aiModel      String?  @map("ai_model")
  tokensUsed   Int?     @map("tokens_used")
  duration     Int? // milliseconds
  cost         Decimal? @db.Decimal(10, 6) // Estimated cost
  errorMessage String?  @map("error_message") @db.Text
  metadata     Json? // Additional generation details
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([type, status])
  @@map("pulse_generation_logs")
}

// ============================================
// BLOG & CONTENT
// ============================================

model BlogCategory {
  id          String   @id @default(cuid())
  name        String   @unique // "Austin Events", "Restaurant News", "Food Scene", "Hospitality Tips"
  slug        String   @unique
  description String?  @db.Text
  color       String?  @default("#A67C52") // Hex color for category badge
  icon        String? // lucide icon name
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  posts BlogPost[]

  @@map("blog_categories")
}

model BlogPost {
  id         String @id @default(cuid())
  categoryId String @map("category_id")
  authorId   String @map("author_id")

  // Core Content
  title   String
  slug    String  @unique
  excerpt String? @db.Text // Short description
  content String  @db.Text // Full HTML content

  // SEO
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description") @db.Text
  keywords        String[] @default([])

  // Media
  featuredImage       String? @map("featured_image") // URL or base64
  featuredImagePrompt String? @map("featured_image_prompt") @db.Text // AI prompt used
  imageAltText        String? @map("image_alt_text")

  // Publishing
  status      String   @default("draft") // draft, published, archived
  publishedAt DateTime? @map("published_at")

  // Analytics
  viewCount    Int      @default(0) @map("view_count")
  readTime     Int?     @map("read_time") // estimated minutes
  lastViewedAt DateTime? @map("last_viewed_at")

  // AI Generation
  isAiGenerated    Boolean @default(false) @map("is_ai_generated")
  aiModel          String? @map("ai_model") // gemini-2.0-flash-exp
  aiGenerationData Json?   @map("ai_generation_data") // prompt, params, etc.

  // Content Focus (for AI generation)
  targetArea     String? @map("target_area") // "Austin, TX"
  contentFocus   String? @map("content_focus") // "new_openings", "events", "best_of", etc.
  targetAudience String? @map("target_audience") // "Foodies", "Industry Pros"
  tone           String? // "Buzzy", "Professional", "Fun"

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  category BlogCategory @relation(fields: [categoryId], references: [id])
  author   User         @relation(fields: [authorId], references: [id])

  @@index([status, publishedAt])
  @@index([categoryId])
  @@index([slug])
  @@map("blog_posts")
}

model BlogGenerationIdea {
  id String @id @default(cuid())

  // Generation Parameters
  targetArea     String @map("target_area")
  category       String
  contentFocus   String @map("content_focus")
  targetAudience String @map("target_audience")
  tone           String

  // Generated Ideas (4 options)
  ideas Json // Array of { title, angle, hook, keywords }

  // AI Metadata
  aiModel   String @map("ai_model")
  usedForId String? @map("used_for_id") // BlogPost ID if one was created

  createdAt DateTime @default(now()) @map("created_at")

  @@map("blog_generation_ideas")
}

// ============================================
// CREATIVE HUB - MARKETING CONTENT GENERATOR
// ============================================

model CreativeProject {
  id          String  @id @default(cuid())
  companyId   String  @map("company_id")
  createdById String  @map("created_by_id")

  name        String
  description String? @db.Text
  status      String  @default("active") // active, archived

  // Campaign context
  campaignGoal   String? @map("campaign_goal") // awareness, engagement, leads, sales
  targetAudience String? @map("target_audience") @db.Text
  brandVoice     String? @map("brand_voice") // professional, friendly, authoritative

  // Defaults for content generation
  defaultTone     String? @default("professional")
  defaultIndustry String? @default("commercial_cleaning") @map("default_industry")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  contentItems CreativeContent[]
  imageAssets  CreativeImage[]

  @@index([companyId, status])
  @@map("creative_projects")
}

model CreativeContent {
  id        String @id @default(cuid())
  projectId String @map("project_id")

  // Content type
  contentType String @map("content_type") // social_post, ad_creative
  platform    String // linkedin, instagram, facebook, twitter, meta_ad, google_display, linkedin_ad

  // Generated content
  headline     String?  @db.Text
  primaryText  String   @map("primary_text") @db.Text
  description  String?  @db.Text
  callToAction String?  @map("call_to_action")
  hashtags     String[] @default([])

  // For ads
  adFormat String? @map("ad_format") // single_image, carousel, story, video_placeholder

  // Associated image
  imageId String? @map("image_id")

  // Status
  status       String    @default("draft") // draft, approved, published, archived
  approvedAt   DateTime? @map("approved_at")
  approvedById String?   @map("approved_by_id")

  // AI Generation metadata
  isAiGenerated    Boolean @default(true) @map("is_ai_generated")
  aiModel          String? @map("ai_model")
  aiGenerationData Json?   @map("ai_generation_data") // prompts, params, variations

  // Variation tracking
  variationGroup String? @map("variation_group") // groups A/B variants together
  variationLabel String? @map("variation_label") // A, B, C

  // Export tracking
  exportedAt   DateTime? @map("exported_at")
  exportFormat String?   @map("export_format")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project CreativeProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  image   CreativeImage?  @relation(fields: [imageId], references: [id])

  @@index([projectId, platform])
  @@index([contentType, status])
  @@map("creative_content")
}

model CreativeImage {
  id        String  @id @default(cuid())
  projectId String? @map("project_id") // null for library images
  companyId String  @map("company_id")

  // Image data
  name        String
  imageUrl    String? @map("image_url") // Supabase storage URL
  imageBase64 String? @map("image_base64") @db.Text // For AI-generated images

  // Metadata
  imageType   String @map("image_type") // before_after, branded_graphic, team_photo, promotional, service_showcase, quote_card, stat_graphic
  aspectRatio String @default("1:1") @map("aspect_ratio") // 1:1, 4:3, 16:9, 9:16, 3:4
  width       Int?
  height      Int?

  // AI Generation
  isAiGenerated Boolean @default(false) @map("is_ai_generated")
  aiPrompt      String? @map("ai_prompt") @db.Text
  aiModel       String? @map("ai_model") // imagen-3.0-generate-002

  // Categorization
  tags     String[] @default([])
  category String? // transformation, quote_card, stat_graphic, team, service

  // Status
  status String @default("active") // active, archived

  createdAt DateTime @default(now()) @map("created_at")

  project  CreativeProject?  @relation(fields: [projectId], references: [id])
  contents CreativeContent[]

  @@index([companyId, category])
  @@index([projectId])
  @@map("creative_images")
}

model CreativeTemplate {
  id          String @id @default(cuid())
  companyId   String @map("company_id")
  createdById String @map("created_by_id")

  name        String
  description String? @db.Text

  // Template configuration
  contentType String @map("content_type") // social_post, ad_creative
  platform    String // linkedin, instagram, etc.

  // Prompt templates
  promptTemplate  String  @map("prompt_template") @db.Text
  imagePromptHint String? @map("image_prompt_hint") @db.Text

  // Defaults
  defaultTone     String?  @default("professional")
  defaultHashtags String[] @default([]) @map("default_hashtags")
  defaultCta      String?  @map("default_cta")

  // Style guidance
  styleGuide Json? @map("style_guide") // structured style preferences

  isBuiltIn Boolean @default(false) @map("is_built_in")
  isActive  Boolean @default(true) @map("is_active")
  useCount  Int     @default(0) @map("use_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, contentType])
  @@index([platform])
  @@map("creative_templates")
}

// ============================================
// DAILY INSPIRATION - CREATIVE HUB TOPICS
// ============================================

enum InspirationCategory {
  AUSTIN_LOCAL // Local restaurants, bars, venues, events
  POP_CULTURE // Trending national topics, viral moments
  SEASONAL // Holidays, seasonal themes, weather
}

enum InspirationStatus {
  PENDING // Awaiting approval
  APPROVED // Ready to use
  REJECTED // Not suitable
  USED // Already created content from this
  EXPIRED // Time-sensitive topic passed
}

model InspirationTopic {
  id        String @id @default(cuid())
  companyId String @map("company_id")

  // Topic Content
  title   String // "Salty Sow Opens New Downtown Location"
  summary String @db.Text // Brief hook for the topic
  context String? @db.Text // Additional context/details

  // Categorization
  category    InspirationCategory // austin_local, pop_culture, seasonal
  subcategory String? // restaurants, bars, events, holidays, etc.

  // Source Attribution
  sourceType String  @default("ai_discovery") @map("source_type") // ai_discovery, web_search, manual
  sourceUrl  String? @map("source_url")
  sourceName String? @map("source_name")

  // AI-Generated Content Ideas (pre-generated post angles)
  postIdeas       Json     @default("[]") @map("post_ideas")
  suggestedHooks  String[] @default([]) @map("suggested_hooks")
  relatedHashtags String[] @default([]) @map("related_hashtags")

  // Metadata
  relevanceScore Float    @default(0.5) @map("relevance_score") // AI-scored relevance
  trendingScore  Float?   @map("trending_score") // How "hot" is this topic
  expiresAt      DateTime? @map("expires_at") // Auto-expire time-sensitive topics

  // Status & Workflow
  status         InspirationStatus @default(PENDING)
  approvedAt     DateTime?         @map("approved_at")
  approvedById   String?           @map("approved_by_id")
  rejectedReason String?           @map("rejected_reason")

  // Image for the topic card
  imageUrl    String? @map("image_url")
  imagePrompt String? @map("image_prompt") @db.Text

  // Usage Tracking
  usedInContentId String?   @map("used_in_content_id") // Links to CreativeContent
  usedAt          DateTime? @map("used_at")

  // Date/Time
  discoveredAt DateTime @default(now()) @map("discovered_at")
  forDate      DateTime @db.Date @map("for_date") // Which date this topic is relevant for
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  briefing   InspirationBriefing? @relation(fields: [briefingId], references: [id])
  briefingId String?              @map("briefing_id")

  @@index([companyId, forDate, status])
  @@index([category, status])
  @@index([forDate, category])
  @@map("inspiration_topics")
}

model InspirationBriefing {
  id        String @id @default(cuid())
  companyId String @map("company_id")

  // Briefing Date
  forDate DateTime @db.Date @map("for_date")

  // Generation Status
  status String @default("generating") // generating, ready, failed

  // AI-Generated Summary
  headline String? // "Austin's Buzzing This Week"
  greeting String? @db.Text // Personalized morning greeting
  summary  String? @db.Text // Quick overview of today's topics

  // Generation Metadata
  aiModel        String? @map("ai_model")
  generatedAt    DateTime? @map("generated_at")
  generationTime Int?    @map("generation_time") // milliseconds
  errorMessage   String? @map("error_message") @db.Text

  // Topic Stats
  totalDiscovered Int @default(0) @map("total_discovered")
  totalApproved   Int @default(0) @map("total_approved")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  topics InspirationTopic[]

  @@unique([companyId, forDate])
  @@index([companyId, forDate])
  @@map("inspiration_briefings")
}

// ============================================
// TASK & PROJECT MANAGEMENT (Personal Productivity)
// ============================================

model Project {
  id          String    @id @default(cuid())
  companyId   String    @map("company_id")
  userId      String    @map("user_id")

  name        String
  description String?   @db.Text
  color       String    @default("#3B82F6") // Hex color for visual identification
  status      String    @default("active") // active, completed, archived

  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  sortOrder   Int       @default(0) @map("sort_order")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([userId, status])
  @@index([companyId])
  @@map("projects")
}

model Goal {
  id          String    @id @default(cuid())
  companyId   String    @map("company_id")
  userId      String    @map("user_id")

  title       String
  description String?   @db.Text

  // Time horizon
  period      String    // "weekly" or "monthly"
  periodStart DateTime  @map("period_start")  // Start of week/month
  periodEnd   DateTime  @map("period_end")    // End of week/month

  // Status & Progress
  status      String    @default("active")    // active, completed, abandoned, rolled_over
  progress    Int       @default(0)           // 0-100 calculated from linked tasks
  completedAt DateTime? @map("completed_at")

  // Optional parent (monthly goal that this weekly goal supports)
  parentId    String?   @map("parent_id")
  parent      Goal?     @relation("GoalHierarchy", fields: [parentId], references: [id])
  children    Goal[]    @relation("GoalHierarchy")

  // Display
  color       String    @default("#3B82F6")
  sortOrder   Int       @default(0) @map("sort_order")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks       Task[]    // Tasks linked to this goal

  @@index([userId, period, periodStart])
  @@index([parentId])
  @@map("goals")
}

model Task {
  id          String    @id @default(cuid())
  companyId   String    @map("company_id")
  userId      String    @map("user_id")
  projectId   String?   @map("project_id")
  goalId      String?   @map("goal_id")

  title       String
  description String?   @db.Text
  status      String    @default("todo") // todo, in_progress, done, cancelled
  priority    String    @default("medium") // low, medium, high, urgent

  dueDate       DateTime? @map("due_date")
  scheduledDate DateTime? @map("scheduled_date") // For calendar view
  completedAt   DateTime? @map("completed_at")

  kanbanOrder Int @default(0) @map("kanban_order")

  // AI Focus fields
  isFocusTask   Boolean   @default(false) @map("is_focus_task")
  focusDate     DateTime? @map("focus_date")
  focusReason   String?   @map("focus_reason") @db.Text
  focusPriority Int?      @map("focus_priority") // 1-5 ranking for the day

  // Starred tasks (manual pin to top of daily view)
  isStarred Boolean   @default(false) @map("is_starred")
  starredAt DateTime? @map("starred_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  goal    Goal?    @relation(fields: [goalId], references: [id], onDelete: SetNull)
  tags    TaskTagAssignment[]
  links   TaskLink[]

  @@index([userId, status])
  @@index([projectId])
  @@index([goalId])
  @@index([dueDate])
  @@index([scheduledDate])
  @@index([isFocusTask, focusDate])
  @@index([userId, isStarred])
  @@map("tasks")
}

model TaskTag {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  userId    String   @map("user_id")
  name      String
  color     String   @default("#6B7280") // Hex color

  createdAt DateTime @default(now()) @map("created_at")

  user  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks TaskTagAssignment[]

  @@unique([userId, name])
  @@index([userId])
  @@map("task_tags")
}

model TaskTagAssignment {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  tagId     String   @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  task Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  TaskTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@map("task_tag_assignments")
}

model TaskLink {
  id          String   @id @default(cuid())
  taskId      String   @map("task_id")
  entityType  String   @map("entity_type") // client, prospect, location, invoice, creative_content
  entityId    String   @map("entity_id")
  entityLabel String?  @map("entity_label") // Denormalized for quick display

  createdAt DateTime @default(now()) @map("created_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, entityType, entityId])
  @@index([taskId])
  @@index([entityType, entityId])
  @@map("task_links")
}
